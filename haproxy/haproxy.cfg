global
    log stdout format raw local0
    maxconn 4096
    daemon
	
defaults
    log     global
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    mode tcp
	
listen stats
    bind *:1936
    mode http
    log global
    stats enable
    stats realm Haproxy\ Statistics 
    stats uri /

listen rabbitmq_http
    bind *:15672
    mode http
    server rabbitmq1_http rabbitmq1:15672 check
    server rabbitmq2_http rabbitmq2:15672 check
    server rabbitmq3_http rabbitmq3:15672 check

listen rabbitmq
    bind *:5672
    mode tcp
    server rabbitmq1 rabbitmq1:5672 check
    server rabbitmq2 rabbitmq2:5672 check
    server rabbitmq3 rabbitmq3:5672 check

# ===================== Redis Sentinel Cluster (Master auto-detect) =====================
listen redis
    bind *:6379
    mode tcp
    balance first
    option tcp-check
	timeout connect 5s
    timeout check 5s
    tcp-check connect
	tcp-check send "PING\r\n"
    tcp-check expect string +PONG
    default-server inter 3s fall 3 rise 2
	server redis1 redis1:6379 check
    server redis2 redis2:6379 check
    server redis3 redis3:6379 check

# SignalR Service Load Balancing
frontend signalr_front
    bind *:5000
    mode http
	option httplog
    option forwardfor
    default_backend signalr_backend

backend signalr_backend
    mode http
    balance roundrobin
    option httpchk GET /health
	http-request set-header Connection upgrade if { hdr(Upgrade) -i WebSocket }
    http-request set-header Upgrade WebSocket if { hdr(Upgrade) -i WebSocket }
    server signalr1 signalr1:5000 check
    server signalr2 signalr2:5000 check
